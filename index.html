<!DOCTYPE html>
<html lang="es">
<head>
  <!-- ... (otros head elements permanecen igual) ... -->
  <style>
    /* Estilos para el carrusel */
    .carousel-container {
      display: flex;
      overflow-x: auto;
      gap: 15px;
      padding: 10px 0;
      scroll-behavior: smooth;
      position: relative;
      max-width: 100%;
    }

    .video-frame {
      background: rgba(255, 255, 255, 0.1);
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 10px;
      width: 300px;
      height: 200px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: border-color 0.3s, transform 0.3s;
    }

    .video-frame:hover {
      border-color: rgba(255, 255, 255, 0.6);
      transform: scale(1.02);
    }

    .video-frame iframe {
      width: 100%;
      height: 100%;
      border: none;
      border-radius: 8px;
    }

    .video-frame.add-video {
      background: rgba(0, 0, 0, 0.2);
      cursor: pointer;
      font-size: 40px;
      color: #fff;
      text-shadow: 0 0 5px rgba(255, 255, 255, 0.5);
    }

    .video-frame.add-video:hover {
      background: rgba(0, 0, 0, 0.4);
    }

    .carousel-nav {
      display: flex;
      justify-content: space-between;
      position: absolute;
      top: 50%;
      width: 100%;
      transform: translateY(-50%);
      padding: 0 10px;
    }

    .carousel-nav button {
      background: rgba(0, 0, 0, 0.5);
      border: none;
      color: #fff;
      font-size: 20px;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      cursor: pointer;
      transition: background 0.3s;
    }

    .carousel-nav button:hover {
      background: rgba(0, 0, 0, 0.7);
    }

    .carousel-nav button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <!-- ... (otros body elements permanecen igual) ... -->

  <div id="addNoteOptions">
    <div class="card" id="addImageLinkOption" title="A침adir un carrusel de videos de YouTube">
      <h2>游꿘 Video</h2>
      <p>Crear un carrusel de videos de YouTube.</p>
    </div>
    <div class="card" id="addTextNoteOption" title="A침adir una nota de texto simple">
      <h2>游닇 Nota</h2>
      <p>Subir nota de texto.</p>
    </div>
  </div>

  <div id="inputArea">
    <div id="imageLinkInputArea" style="display: none;">
      <div class="input-group">
        <label for="videoLink">Link del video de YouTube:</label>
        <input type="text" id="videoLink" placeholder="Pega aqu칤 la URL de YouTube (ej: https://www.youtube.com/watch?v=dQw4w9WgXcQ)" />
      </div>
      <div class="input-group">
        <label for="videoNoteText">Texto adicional (opcional):</label>
        <textarea id="videoNoteText" placeholder="Escribe aqu칤 una descripci칩n o nota..." rows="3"></textarea>
      </div>
      <button id="saveVideoLink">Guardar Video</button>
    </div>
    <div id="textNoteInputArea" style="display: none;">
      <!-- ... (permanece igual) ... -->
    </div>
  </div>

  <div class="container">
    <div id="zoom-container">
      <div id="notaDisplay" class="grid-stack"></div>
    </div>
  </div>

  <!-- ... (otros body elements permanecen igual) ... -->

  <script>
    // --- Funci칩n para extraer ID de YouTube ---
    function getYouTubeId(url) {
      const regex = /(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/watch\?v=|youtu\.be\/)([\w-]{11})/;
      const match = url.match(regex);
      return match ? match[1] : null;
    }

    // --- Funci칩n para guardar enlace de video en un carrusel existente ---
    function guardarLinkDeVideo() {
      const videoLinkInputElem = getElement('videoLink');
      const videoNoteTextElem = getElement('videoNoteText');
      const saveVideoLinkButtonElem = getElement('saveVideoLink');

      if (!videoLinkInputElem || !db) return;
      let link = videoLinkInputElem.value.trim();
      const texto = videoNoteTextElem ? videoNoteTextElem.value.trim() : '';
      const videoId = getYouTubeId(link);

      if (!videoId) {
        alert("Introduce un enlace v치lido de YouTube.");
        videoLinkInputElem.focus();
        return;
      }

      if (saveVideoLinkButtonElem) saveVideoLinkButtonElem.disabled = true;

      // Obtener la nota activa o crear una nueva
      let noteId = localStorage.getItem('activeCarouselNoteId');
      if (!noteId) {
        db.collection('notas').add({
          tipo: 'video',
          texto: texto || null,
          videos: [videoId],
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          w: 12,
        }).then((docRef) => {
          noteId = docRef.id;
          localStorage.setItem('activeCarouselNoteId', noteId);
          console.log("Nuevo carrusel creado con ID:", noteId);
          hidePopups();
        });
      } else {
        db.collection('notas').doc(noteId).get().then((doc) => {
          if (doc.exists) {
            const data = doc.data();
            const videos = data.videos || [];
            videos.push(videoId);
            return db.collection('notas').doc(noteId).update({
              videos: videos,
              texto: texto || data.texto || null,
            });
          } else {
            localStorage.removeItem('activeCarouselNoteId');
            return guardarLinkDeVideo(); // Reiniciar si la nota no existe
          }
        }).then(() => {
          console.log("Video a침adido al carrusel existente:", noteId);
          hidePopups();
        });
      }.catch((error) => {
        console.error('Error al guardar video:', error);
        alert("Error al guardar video: " + error.message);
      }).finally(() => {
        if (saveVideoLinkButtonElem) saveVideoLinkButtonElem.disabled = false;
      });
    }

    // --- Actualizar mostrarNotaEnPantalla para carrusel interactivo ---
    function mostrarNotaEnPantalla(doc) {
      const notaData = doc.data();
      const noteId = doc.id;

      if (!notaData || (!notaData.videos && !notaData.nota)) {
        console.warn(`Datos inv치lidos o incompletos para nota ${noteId}, no se mostrar치.`);
        return null;
      }

      let gridItem = document.createElement('div');
      gridItem.classList.add('grid-stack-item');
      gridItem.setAttribute('data-note-id', noteId);
      gridItem.setAttribute('data-note-type', notaData.tipo || (notaData.videos ? 'video' : 'texto'));

      const content = document.createElement('div');
      content.classList.add('grid-stack-item-content');

      let card;
      let noteContentElement = null;

      if (notaData.videos) {
        card = document.createElement('div');
        card.classList.add('card-wrapper');

        const carouselContainer = document.createElement('div');
        carouselContainer.classList.add('carousel-container');
        carouselContainer.setAttribute('data-note-id', noteId);

        // A침adir 5 cuadros iniciales (con o sin videos)
        const initialVideos = notaData.videos || [];
        for (let i = 0; i < Math.max(5, initialVideos.length); i++) {
          const videoFrame = document.createElement('div');
          videoFrame.classList.add('video-frame');
          if (i < initialVideos.length) {
            const iframe = document.createElement('iframe');
            iframe.src = `https://www.youtube.com/embed/${initialVideos[i]}`;
            iframe.width = "300";
            iframe.height = "200";
            iframe.frameborder = "0";
            iframe.allow = "accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture";
            iframe.allowFullscreen = true;
            videoFrame.appendChild(iframe);
          } else {
            videoFrame.classList.add('add-video');
            videoFrame.innerHTML = '+';
            videoFrame.onclick = () => {
              localStorage.setItem('activeCarouselNoteId', noteId);
              if (getElement('addNoteOptions')) getElement('addNoteOptions').style.display = 'none';
              if (getElement('imageLinkInputArea')) getElement('imageLinkInputArea').style.display = 'block';
              if (getElement('textNoteInputArea')) getElement('textNoteInputArea').style.display = 'none';
              if (getElement('inputArea')) getElement('inputArea').style.display = 'flex';
              if (document.querySelector('.blur-background')) document.querySelector('.blur-background').style.display = 'block';
              if (getElement('videoLink')) getElement('videoLink').focus();
            };
          }
          carouselContainer.appendChild(videoFrame);
        }

        // A침adir navegaci칩n
        const nav = document.createElement('div');
        nav.classList.add('carousel-nav');
        const prevButton = document.createElement('button');
        prevButton.innerHTML = '&lt;';
        prevButton.onclick = (e) => {
          e.stopPropagation();
          carouselContainer.scrollLeft -= 320;
          updateNavButtons(carouselContainer, prevButton, nextButton);
        };
        const nextButton = document.createElement('button');
        nextButton.innerHTML = '&gt;';
        nextButton.onclick = (e) => {
          e.stopPropagation();
          carouselContainer.scrollLeft += 320;
          updateNavButtons(carouselContainer, prevButton, nextButton);
        };
        nav.appendChild(prevButton);
        nav.appendChild(nextButton);
        carouselContainer.appendChild(nav);

        card.appendChild(carouselContainer);

        if (notaData.texto) {
          noteContentElement = document.createElement('div');
          noteContentElement.classList.add('note-content');
          noteContentElement.innerHTML = linkify(notaData.texto);
          card.appendChild(noteContentElement);
        }
      } else if (notaData.nota) {
        card = document.createElement('div');
        card.classList.add('text-card');
        noteContentElement = document.createElement('div');
        noteContentElement.classList.add('note-content');
        noteContentElement.innerHTML = linkify(notaData.nota);
        card.appendChild(noteContentElement);
      } else {
        return null;
      }

      if (noteContentElement) {
        Array.from(noteContentElement.getElementsByTagName('a')).forEach(link => {
          link.setAttribute('target', '_blank');
          link.setAttribute('rel', 'noopener noreferrer');
        });
      }

      const menuBar = document.createElement('div');
      menuBar.classList.add('menu-bar');
      // ... (resto del c칩digo de menuBar permanece igual) ...

      card.appendChild(menuBar);
      content.appendChild(card);
      gridItem.appendChild(content);

      const pos = {
        x: typeof notaData.x === 'number' ? notaData.x : undefined,
        y: typeof notaData.y === 'number' ? notaData.y : undefined,
        w: notaData.w || 12,
        id: noteId,
        autoPosition: (typeof notaData.x !== 'number' || typeof notaData.y !== 'number')
      };

      gridItem.docData = notaData;

      return { element: gridItem, position: pos };
    }

    // --- Funci칩n para actualizar botones de navegaci칩n ---
    function updateNavButtons(container, prevButton, nextButton) {
      prevButton.disabled = container.scrollLeft <= 0;
      nextButton.disabled = container.scrollLeft >= (container.scrollWidth - container.clientWidth);
    }

    // --- Asignar listener al bot칩n de guardar video ---
    document.addEventListener('DOMContentLoaded', () => {
      const addImgOpt = getElement('addImageLinkOption');
      const saveVideoBtn = getElement('saveVideoLink');

      if (addImgOpt) {
        addImgOpt.onclick = (e) => {
          e.stopPropagation();
          db.collection('notas').add({
            tipo: 'video',
            videos: [],
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            w: 12,
          }).then((docRef) => {
            localStorage.setItem('activeCarouselNoteId', docRef.id);
            if (getElement('addNoteOptions')) getElement('addNoteOptions').style.display = 'none';
            if (getElement('imageLinkInputArea')) getElement('imageLinkInputArea').style.display = 'block';
            if (getElement('textNoteInputArea')) getElement('textNoteInputArea').style.display = 'none';
            if (getElement('inputArea')) getElement('inputArea').style.display = 'flex';
            if (document.querySelector('.blur-background')) document.querySelector('.blur-background').style.display = 'block';
            if (getElement('videoLink')) getElement('videoLink').focus();
          });
        };
      }

      if (saveVideoBtn) saveVideoBtn.onclick = guardarLinkDeVideo;
    });

    // --- (Resto del script permanece igual) ... ---
  </script>

  <!-- ... (otros scripts y cierre de body/html permanecen igual) ... -->
</html>
